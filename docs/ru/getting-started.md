# Начало работы

Это руководство поможет вам интегрировать ApiPay.kz в ваше приложение и начать принимать платежи через Kaspi Pay.

## Подготовка

Перед созданием счетов необходимо:

1. **Получить API ключ** — Зарегистрируйтесь на [baypay.bazarbay.site](https://baypay.bazarbay.site/login) и получите API ключ в личном кабинете
2. **Настроить Kaspi Business** — Добавьте наш сервисный номер в приложение Kaspi Business
3. **Верифицировать организацию** — Пройдите верификацию через API

## Шаг 1: Настройка Kaspi Business

1. Откройте приложение **Kaspi Business** на телефоне
2. Перейдите в **Настройки → Сотрудники → Добавить сотрудника**
3. Добавьте номер телефона: **77056610934**
4. Установите роль: **Кассир**
5. Подтвердите добавление

> **Важно**: Этот шаг позволяет ApiPay.kz создавать счета от имени вашей организации.

## Шаг 2: Получение API ключа

1. Перейдите на [baypay.bazarbay.site/login](https://baypay.bazarbay.site/login)
2. Войдите через WhatsApp
3. Перейдите в **Настройки → Подключение**
4. Скопируйте ваш API ключ

## Шаг 3: Верификация организации

Отправьте запрос верификации с вашим ИИН (индивидуальный идентификационный номер) или БИН (бизнес-идентификационный номер):

```bash
curl -X POST https://bpapi.bazarbay.site/api/organizations/verify \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"idn": "123456789012"}'
```

**Тело запроса:**
| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| `idn` | string | Да | 12-значный ИИН или БИН |

**Ответ:**
```json
{
  "organization": {
    "id": 1,
    "status": "pending"
  },
  "message": "Верификация запущена. Подтвердите в приложении Kaspi Business."
}
```

## Шаг 4: Проверка статуса верификации

Пользователь должен подтвердить верификацию в приложении Kaspi Business в течение 2 минут.

Опрашивайте статус каждые 2 секунды:

```bash
curl https://bpapi.bazarbay.site/api/organizations/1/status \
  -H "X-API-Key: YOUR_API_KEY"
```

**Ответ:**
```json
{
  "organization": {
    "id": 1,
    "idn": "123456789012",
    "status": "verified",
    "time_remaining": 95
  }
}
```

**Возможные статусы:**
- `pending` — Ожидание подтверждения
- `verified` — Организация верифицирована, можно создавать счета
- `failed` — Верификация не удалась

> **Примечание**: Верификация истекает через 120 секунд. При таймауте начните процесс заново.

## Шаг 5: Создание первого счёта

После верификации можно создавать счета:

```bash
curl -X POST https://bpapi.bazarbay.site/api/invoices \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 10000,
    "phone_number": "87001234567",
    "description": "Заказ #123"
  }'
```

**Ответ:**
```json
{
  "id": 42,
  "kaspi_invoice_id": "13234689513",
  "kaspi_qr_token": "abc123",
  "payment_url": "https://kaspi.kz/pay/...",
  "amount": "10000.00",
  "status": "pending",
  "created_at": "2025-01-31T12:00:00Z"
}
```

## Шаг 6: Редирект клиента

Перенаправьте клиента на `payment_url` для оплаты:

```javascript
// После создания счёта
window.location.href = data.payment_url
```

Клиент:
1. Откроет Kaspi Pay в браузере
2. Подтвердит сумму платежа
3. Оплатит картой Kaspi Gold

## Шаг 7: Обработка уведомлений об оплате

Настройте webhook для получения уведомлений о платежах в реальном времени. См. [Webhooks](webhooks.md).

## Конфигурация API

| Параметр | Значение |
|----------|----------|
| Base URL | `https://bpapi.bazarbay.site/api` |
| Аутентификация | Заголовок `X-API-Key: your_api_key` |
| Content-Type | `application/json` |
| Rate Limit | 60 запросов/минуту |

## Следующие шаги

- [Счета](invoices.md) — Управление счетами
- [Рекуррентные платежи](recurring.md) — Настройка подписок
- [Webhooks](webhooks.md) — Настройка уведомлений о платежах
- [Коды ошибок](errors.md) — Правильная обработка ошибок
